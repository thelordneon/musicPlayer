<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web Music Player — Fixed (Full)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsmediatags/3.9.5/jsmediatags.min.js"></script>

    <style>
        /* --- Basic Setup --- */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap');

        :root {
            --bg-color: #1e1e2e;
            --player-bg: rgba(255, 255, 255, 0.08);
            --primary-text: #e0e0e0;
            --secondary-text: #a0a0b0;
            --accent-color: #89b4fa;
            --icon-color: #cdd6f4;
            --shadow-color: rgba(0, 0, 0, 0.4);
            /* --- Progress bar styling variables --- */
            --active-track-height: 2px;
            --inactive-track-height: 4px;
            --thumb-width: 5px;
            --thumb-height: 15px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background-color: var(--bg-color);
            color: var(--primary-text);
            padding: 20px;
        }

        /* --- Music Player Container --- */
        .music-player {
            width: 100%;
            max-width: 380px;
            background: var(--player-bg);
            border-radius: 24px;
            padding: 24px;
            box-shadow: 0 10px 30px var(--shadow-color);
            position: relative;
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
        }

        .music-player::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            bottom: 0;
            left: 0;
            background-image: var(--background-image, url(''));
            background-size: cover;
            background-position: center;
            filter: blur(30px) brightness(0.5);
            transform: scale(1.2);
            z-index: -1;
            transition: background-image 0.7s ease-in-out;
        }

        /* --- File Input --- */
        #file-input-label {
            display: block;
            width: 100%;
            padding: 12px;
            background-color: var(--accent-color);
            color: var(--bg-color);
            text-align: center;
            border-radius: 12px;
            cursor: pointer;
            margin-bottom: 20px;
            font-weight: 500;
            transition: background-color 0.3s;
        }

        #file-input-label:hover {
            background-color: #a6c1ee;
        }

        #file-input {
            display: none;
        }

        /* --- Artwork and Info --- */
        .track-info-container {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 20px;
        }

        .artwork {
            width: 80px;
            height: 80px;
            border-radius: 12px;
            box-shadow: 0 4px 15px var(--shadow-color);
            object-fit: cover;
            flex-shrink: 0;
            transition: transform 0.45s ease, opacity 0.45s ease;
        }

        .track-info {
            min-width: 0;
        }

        .track-info .title {
            font-size: 1.2rem;
            font-weight: 700;
            margin-bottom: 4px;
            color: #fff;
        }

        .track-info .artist {
            font-size: 0.9rem;
            color: var(--secondary-text);
        }

        /* --- Scrolling Text Animation (marquee-like) --- */
        .title-container, .artist-container {
            width: 100%;
            overflow: hidden;
        }

        .title, .artist {
            white-space: nowrap;
            display: inline-block;
            animation: none;
            padding-right: 1.5em;
            will-change: transform;
        }

        .title.scrolling, .artist.scrolling {
            animation: marquee 8s linear infinite;
        }
        
        @keyframes marquee {
            0% { transform: translateX(0%); }
            50% { transform: translateX(var(--scroll-amount)); }
            100% { transform: translateX(0%); }
        }


        /* --- Progress Bar --- */
        .progress-container {
            width: 100%;
            margin-bottom: 10px;
            position: relative;
            height: 24px;
            display: flex;
            align-items: center;
            cursor: pointer;
        }

        #waveCanvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        .timestamps {
            display: flex;
            justify-content: space-between;
            font-size: 0.75rem;
            color: var(--secondary-text);
            margin-top: -5px;
        }

        /* --- Controls --- */
        .main-controls {
            display: flex;
            justify-content: space-around;
            align-items: center;
        }

        .control-btn {
            background: none;
            border: none;
            color: var(--icon-color);
            cursor: pointer;
            transition: color 0.3s, transform 0.12s;
            width: 44px;
            height: 44px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .control-btn svg {
            width: 25px;
            height: 30px;
            fill: currentColor;
        }

        .control-btn:hover { transform: translateY(-3px); }

        .control-btn.active { color: var(--accent-color); }

        .play-pause-btn {
            width: 45px;
            height: 45px;
            color: #fff;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            transition: background 0.3s, transform 0.12s;
        }

        .play-pause-btn:hover { background: rgba(255,255,255,0.2); transform: translateY(-4px); }

        .play-pause-btn svg { width: 28px; height: 28px; margin-left: 2px; }
        .play-pause-btn .pause-icon { width: 24px; height: 24px; margin-left: 0; }

        /* --- Collapsible Speed Controls --- */
        .speed-controls { background: rgba(0,0,0,0.2); border-radius: 12px; margin-top: 16px; max-height: 0; opacity: 0; overflow: hidden; transition: max-height 0.36s ease, opacity 0.36s ease, padding 0.36s ease; }
        .speed-controls.expanded { max-height: 100px; opacity: 1; padding: 12px; }
        .speed-control-inner { display:flex; align-items:center; gap:12px; }
        .speed-control-inner .value-display { font-size:0.8rem; min-width:40px; text-align:right; color:var(--primary-text);} 

        .speed-adjust-btn { background-color: rgba(255,255,255,0.1); border:1px solid rgba(255,255,255,0.12); color:var(--primary-text); width:24px; height:24px; border-radius:50%; cursor:pointer; font-size:16px; line-height:22px; text-align:center; padding:0; }

        /* Small responsive tweak */
        @media (max-width: 420px) { .music-player { padding: 18px; } .artwork { width: 70px; height: 70px; } }
    </style>
</head>

<body>

    <div class="music-player">
        <label for="file-input" id="file-input-label">Select Music</label>
        <input type="file" id="file-input" multiple accept="audio/*">

        <div class="track-info-container">
            <img src="https://via.placeholder.com/80" alt="Artwork" class="artwork" id="artwork">
            <div class="track-info">
                <div class="title-container">
                    <h2 class="title" id="title">No Song Selected</h2>
                </div>
                <div class="artist-container">
                    <p class="artist" id="artist">Please select your music files</p>
                </div>
            </div>
        </div>

        <div class="progress-container">
            <canvas id="waveCanvas"></canvas>
        </div>
        <div class="timestamps">
            <span id="current-time">0:00</span>
            <span id="total-time">0:00</span>
        </div>


        <div class="controls-wrapper">
            <div class="main-controls">
                <button class="control-btn" id="shuffle-btn" title="Shuffle">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640"><path d="M467.8 98.4C479.8 93.4 493.5 96.2 502.7 105.3L566.7 169.3C572.7 175.3 576.1 183.4 576.1 191.9C576.1 200.4 572.7 208.5 566.7 214.5L502.7 278.5C493.5 287.7 479.8 290.4 467.8 285.4C455.8 280.4 448 268.9 448 256L448 224L416 224C405.9 224 396.4 228.7 390.4 236.8L358 280L318 226.7L339.2 198.4C357.3 174.2 385.8 160 416 160L448 160L448 128C448 115.1 455.8 103.4 467.8 98.4zM218 360L258 413.3L236.8 441.6C218.7 465.8 190.2 480 160 480L96 480C78.3 480 64 465.7 64 448C64 430.3 78.3 416 96 416L160 416C170.1 416 179.6 411.3 185.6 403.2L218 360zM502.6 534.6C493.4 543.8 479.7 546.5 467.7 541.5C455.7 536.5 448 524.9 448 512L448 480L416 480C385.8 480 357.3 465.8 339.2 441.6L185.6 236.8C179.6 228.7 170.1 224 160 224L96 224C78.3 224 64 209.7 64 192C64 174.3 78.3 160 96 160L160 160C190.2 160 218.7 174.2 236.8 198.4L390.4 403.2C396.4 411.3 405.9 416 416 416L448 416L448 384C448 371.1 455.8 359.4 467.8 354.4C479.8 349.4 493.5 352.2 502.7 361.3L566.7 425.3C572.7 431.3 576.1 439.4 576.1 447.9C576.1 456.4 572.7 464.5 566.7 470.5L502.7 534.5z"/></svg>
                </button>
                <button class="control-btn" id="toggle-speed-btn" title="Speed Control">
                    <svg version="1.0" xmlns="http://www.w3.org/2000/svg" width="512" height="512" viewBox="0 0 512 512" preserveAspectRatio="xMidYMid meet"><g transform="translate(0.000000,512.000000) scale(0.100000,-0.100000)" fill="#FFFFF" stroke="none"><path d="M2355 4248 c-396 -40 -799 -204 -1119 -456 -174 -137 -375 -366 -494 -563 -376 -627 -409 -1386 -87 -2045 102 -209 200 -297 365 -324 45 -7 536 -10 1585 -8 l1520 3 56 23 c133 53 205 132 296 320 100 208 169 441 198 665 17 136 20 384 5 507 -36 295 -130 578 -278 837 -26 46 -49 83 -52 83 -3 0 -63 -88 -134 -195 l-128 -194 45 -113 c25 -62 55 -146 67 -186 117 -402 75 -853 -116 -1234 l-44 -88 -1480 0 -1480 0 -44 88 c-240 479 -242 1033 -5 1518 139 286 357 525 631 696 471 293 1063 337 1572 117 l91 -39 192 128 c106 70 193 130 193 134 0 3 -40 29 -89 57 -373 214 -837 312 -1266 269z"/><path d="M3155 3035 c-514 -343 -904 -610 -923 -631 -72 -83 -108 -211 -91 -332 19 -136 107 -255 236 -319 63 -31 87 -37 157 -41 121 -6 221 26 300 97 30 28 1231 1821 1219 1820 -5 0 -408 -268 -898 -594z"/></g></svg>
                </button>
                <button class="control-btn" id="prev-btn" title="Previous">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640"><path d="M491 100.8C478.1 93.8 462.3 94.5 450 102.6L192 272.1L192 128C192 110.3 177.7 96 160 96C142.3 96 128 110.3 128 128L128 512C128 529.7 142.3 544 160 544C177.7 544 192 529.7 192 512L192 367.9L450 537.5C462.3 545.6 478 546.3 491 539.3C504 532.3 512 518.8 512 504.1L512 136.1C512 121.4 503.9 107.9 491 100.9z"/></svg>
                </button>

                <button class="control-btn play-pause-btn" id="play-pause-btn">
                    <svg class="play-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640"><path d="M187.2 100.9C174.8 94.1 159.8 94.4 147.6 101.6C135.4 108.8 128 121.9 128 136L128 504C128 518.1 135.5 531.2 147.6 538.4C159.7 545.6 174.8 545.9 187.2 539.1L523.2 355.1C536 348.1 544 334.6 544 320C544 305.4 536 291.9 523.2 284.9L187.2 100.9z"/></svg>
                </button>

                <button class="control-btn" id="next-btn" title="Next">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640"><path d="M149 100.8C161.9 93.8 177.7 94.5 190 102.6L448 272.1L448 128C448 110.3 462.3 96 480 96C497.7 96 512 110.3 512 128L512 512C512 529.7 497.7 544 480 544C462.3 544 448 529.7 448 512L448 367.9L190 537.5C177.7 545.6 162 546.3 149 539.3C136 532.3 128 518.7 128 504L128 136C128 121.3 136.1 107.8 149 100.8z"/></svg>
                </button>
                <button class="control-btn" id="repeat-all-btn" title="Repeat All">
                    <svg viewBox="0 0 256 256"><path d="M20,128A76.08645,76.08645,0,0,1,96,52h99.0293l-3.51465-3.51465a12.0001,12.0001,0,0,1,16.9707-16.9707l24,24c.01929.01953.03516.04053.0542.06006.25806.26123.50562.5332.739.81738.1211.14746.22657.30273.3396.4541.12061.16211.2461.31983.35889.48828.11914.17823.22315.3628.33179.54639.09131.15283.1875.30225.272.46.09912.18506.18311.375.27173.56445.07837.166.16162.32959.23242.5.07593.18409.1377.37159.2041.55811.06543.1831.13574.36328.19239.5498.05712.18848.09912.38037.14672.5708.04737.189.10059.37549.13892.56836.0437.22071.07031.44385.10156.66651.02344.165.05493.32763.07129.49463a12.042,12.042,0,0,1,0,2.373c-.01636.167-.04785.32959-.07129.49463-.03125.22266-.05786.4458-.10156.66651-.03833.19287-.09155.37939-.13892.56836-.0476.19043-.0896.38232-.14672.5708-.05665.18652-.127.3667-.19239.5498-.0664.18652-.12817.374-.2041.55811-.0708.17041-.154.334-.23242.5-.08862.18945-.17261.37939-.27173.56445-.08447.15771-.18066.30713-.272.46-.10864.18359-.21265.36816-.33179.54639-.11279.16845-.23828.32617-.35889.48828-.113.15137-.2185.30664-.3396.4541-.23339.28418-.481.55615-.739.81738-.019.01953-.03491.04053-.0542.06006l-24,24a12.0001,12.0001,0,0,1-16.9707-16.9707L195.0293,76H96a52.059,52.059,0,0,0-52,52,12,12,0,0,1-24,0Zm204-12a12.00028,12.00028,0,0,0-12,12,52.059,52.059,0,0,1-52,52H60.9707l3.51465-3.51465a12.0001,12.0001,0,0,0-16.9707-16.9707l-24,24c-.01929.01953-.03516.04053-.0542.06006-.25806.26123-.50562.5332-.739.81738-.1211.14746-.22657.30273-.3396.4541-.12073.16211-.24622.31983-.35877.48828-.11938.17823-.22327.3628-.33191.54639-.09131.15283-.1875.30225-.272.46-.09937.18555-.18384.37647-.27283.56641-.07788.16552-.16052.32812-.23095.49756-.07642.18457-.13831.373-.2052.56054-.06519.18213-.13514.36182-.19166.54785-.05712.18848-.09912.38037-.14672.5708-.04737.189-.10059.37549-.1388.56836-.04382.22071-.07043.44385-.10168.66651-.02332.165-.05493.32763-.07141.49463a12.08048,12.08048,0,0,0,0,2.373c.01648.167.04809.32959.07141.49463.03125.22266.05786.4458.10168.66651.03821.19287.09143.37939.1388.56836.0476.19043.0896.38232.14672.5708.05652.186.12647.36572.19166.54785.06689.1875.12878.376.2052.56054.07043.16944.15307.332.231.49756.089.18994.17346.38086.27283.56641.08447.15771.18066.30713.272.46.10864.18359.21253.36816.33191.54639.11255.16845.238.32617.35877.48828.113.15137.2185.30664.3396.4541.23339.28418.481.55615-.739.81738.019.01953.03491.04053.0542.06006l24,24a12.0001,12.0001,0,0,0,16.9707-16.9707L60.9707,204H160a76.08645,76.08645,0,0,0,76-76A12.00028,12.00028,0,0,0,224,116Z"/></svg>
                </button>
                <button class="control-btn" id="repeat-one-btn" title="Repeat One">
                    <svg viewBox="0 0 256 256">
                        <path
                            d="M20,128A76.08645,76.08645,0,0,1,96,52h99.0293l-3.51465-3.51465a12.0001,12.0001,0,0,1,16.9707-16.9707l24,24c.01929.01953.03516.04053.0542.06006.25806.26123.50562.5332.739.81738.1211.14746.22657.30273.3396.4541.12061.16211.2461.31983.35889.48828.11914.17823.22315.3628.33179.54639.09131.15283.1875.30225.272.46.09912.18506.18311.375.27173.56445.07837.166.16162.32959.23242.5.07593.18409.1377.37159.2041.55811.06543.1831.13574.36328.19239.5498.05712.18848.09912.38037.14672.5708.04737.189.10059.37549.13892.56836.0437.22071.07031.44385.10156.66651.02344.165.05493.32763.07129.49463a12.042,12.042,0,0,1,0,2.373c-.01636.167-.04785.32959-.07129.49463-.03125.22266-.05786.4458-.10156.66651-.03833.19287-.09155.37939-.13892.56836-.0476.19043-.0896.38232-.14672.5708-.05665.18652-.127.3667-.19239.5498-.0664.18652-.12817.374-.2041.55811-.0708.17041-.154.334-.23242.5-.08862.18945-.17261.37939-.27173.56445-.08447.15771-.18066.30713-.272.46-.10864.18359-.21265.36816-.33179.54639-.11279.16845-.23828.32617-.35889.48828-.113.15137-.2185.30664-.3396.4541-.23339.28418-.481.55615-.739.81738-.019.01953-.03491.04053-.0542.06006l-24,24a12.0001,12.0001,0,0,1-16.9707-16.9707L195.0293,76H96a52.059,52.059,0,0,0-52,52,12,12,0,0,1-24,0Zm204-12a12.00028,12.00028,0,0,0-12,12,52.059,52.059,0,0,1-52,52H60.9707l3.51465-3.51465a12.0001,12.0001,0,0,0-16.9707-16.9707l-24,24c-.01929.01953-.03516.04053-.0542.06006-.25806.26123-.50562.5332-.739.81738-.1211.14746-.22657.30273-.3396.4541-.12073.16211-.24622.31983-.35877.48828-.11938.17823-.22327.3628-.33191.54639-.09131.15283-.1875.30225-.272.46-.09937.18555-.18384.37647-.27283.56641-.07788.16552-.16052.32812-.23095.49756-.07642.18457-.13831.373-.2052.56054-.06519.18213-.13514.36182-.19166.54785-.05712.18848-.09912.38037-.14672.5708-.04737.189-.10059.37549-.1388.56836-.04382.22071-.07043.44385-.10168.66651-.02332.165-.05493.32763-.07141.49463a12.08048,12.08048,0,0,0,0,2.373c.01648.167.04809.32959.07141.49463.03125.22266.05786.4458.10168.66651.03821.19287.09143.37939.1388.56836.0476.19043.0896.38232.14672.5708.05652.186.12647.36572.19166.54785.06689.1875.12878.376.2052.56054.07043.16944.15307.332.231.49756.089.18994.17346.38086.27283.56641.08447.15771.18066.30713.272.46.10864.18359.21253.36816.33191.54639.11255.16845.238.32617.35877.48828.113.15137.2185.30664.3396.4541.23339.28418.481.55615-.739.81738.019.01953.03491.04053.0542.06006l24,24a12.0001,12.0001,0,0,0,16.9707-16.9707L60.9707,204H160a76.08645,76.08645,0,0,0,76-76A12.00028,12.00028,0,0,0,224,116Zm-92,48a12.00028,12.00028,0,0,0,12-12V104a11.99979,11.99979,0,0,0-17.3623-10.73535l-16,7.99316A12.00042,12.00042,0,0,0,120,123.30762V152A12.00028,12.00028,0,0,0,132,164Z" />
                    </svg>
                </button>
            </div>

            <div class="speed-controls" id="speed-controls">
                <div class="speed-control-inner">
                    <svg class="speed-label-icon" viewBox="0 0 51.2 51.2">
                        <path d="M235.5 424.8 c-39.6 -4 -79.9 -20.4 -111.9 -45.6 -17.4 -13.7 -37.5 -36.6 -49.4 -56.3 -37.6 -62.7 -40.9 -138.6 -8.7 -204.5 10.2 -20.9 20 -29.7 36.5 -32.4 4.5 -.7 53.6 -1 158.5 -.8 l152 .3 5.6 2.3 c13.3 5.3 20.5 13.2 29.6 32 10 20.8 16.9 44.1 19.8 66.5 1.7 13.6 2 38.4.5 50.7 -3.6 29.5 -13 57.8 -27.8 83.7 -2.6 4.6 -4.9 8.3 -5.2 8.3 -0.3 0 -6.3 -8.8 -13.4 -19.5 l-12.8 -19.4 4.5 -11.3 c2.5 -6.2 5.5 -14.6 6.7 -18.6 11.7 -40.2 7.5 -85.3 -11.6 -123.4 l-4.4 -8.8 -148 0 -148 0 -4.4 8.8 c-24 47.9 -24.2 103.3 -.5 151.8 13.9 28.6 35.7 52.5 63.1 69.6 47.1 29.3 106.3 33.7 157.2 11.7 l9.1 -3.9 19.2 12.8 c10.6 7 19.3 13 19.3 13.4 0 .3 -4 2.9 -8.9 5.7 -37.3 21.4 -83.7 31.2 -126.6 26.9z M315.5 303.5 c-51.4 -34.3 -90.4 -61 -92.3 -63.1 -7.2 -8.3 -10.8 -21.1 -9.1 -33.2 1.9 -13.6 10.7 -25.5 23.6 -31.9 6.3 -3.1 8.7 -3.7 15.7 -4.1 12.1 -.6 22.1 2.6 30 9.7 3 2.8 123.1 182.1 121.9 182 -0.5 0 -40.8 -26.8 -89.8 -59.4z" />
                    </svg>
                    <button class="speed-adjust-btn" id="speed-decrease-btn">-</button>
                    <input type="range" id="speed-slider" min="0.5" max="2" step="0.01" value="1">
                    <button class="speed-adjust-btn" id="speed-increase-btn">+</button>
                    <span class="value-display" id="speed-value">1.00x</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DOM Elements ---
            const fileInput = document.getElementById('file-input');
            const artwork = document.getElementById('artwork');
            const title = document.getElementById('title');
            const artist = document.getElementById('artist');
            const titleContainer = document.querySelector('.title-container');
            const artistContainer = document.querySelector('.artist-container');
            const currentTimeEl = document.getElementById('current-time');
            const totalTimeEl = document.getElementById('total-time');
            const playPauseBtn = document.getElementById('play-pause-btn');
            const prevBtn = document.getElementById('prev-btn');
            const nextBtn = document.getElementById('next-btn');
            const shuffleBtn = document.getElementById('shuffle-btn');
            const speedSlider = document.getElementById('speed-slider');
            const speedValue = document.getElementById('speed-value');
            const toggleSpeedBtn = document.getElementById('toggle-speed-btn');
            const speedControls = document.getElementById('speed-controls');
            const repeatAllBtn = document.getElementById('repeat-all-btn');
            const repeatOneBtn = document.getElementById('repeat-one-btn');
            const speedDecreaseBtn = document.getElementById('speed-decrease-btn');
            const speedIncreaseBtn = document.getElementById('speed-increase-btn');
            const progressContainer = document.querySelector('.progress-container');

            // --- SVG Icons ---
            const playIconSVG = `<svg class="play-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640"><path d="M187.2 100.9C174.8 94.1 159.8 94.4 147.6 101.6C135.4 108.8 128 121.9 128 136L128 504C128 518.1 135.5 531.2 147.6 538.4C159.7 545.6 174.8 545.9 187.2 539.1L523.2 355.1C536 348.1 544 334.6 544 320C544 305.4 536 291.9 523.2 284.9L187.2 100.9z"/></svg>`;
            const pauseIconSVG = `<svg class="pause-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640"><path d="M176 96C149.5 96 128 117.5 128 144L128 496C128 522.5 149.5 544 176 544L240 544C266.5 544 288 522.5 288 496L288 144C288 117.5 266.5 96 240 96L176 96zM400 96C373.5 96 352 117.5 352 144L352 496C352 522.5 373.5 544 400 544L464 544C490.5 544 512 522.5 512 496L512 144C512 117.5 490.5 96 464 96L400 96z"/></svg>`;

            // --- Canvas & drawing ---
            const canvas = document.getElementById('waveCanvas');
            const ctx = canvas.getContext('2d');

            // --- Audio (Web Audio API) ---
            let audioContext;
            let sourceNode = null;
            let audioBuffer = null;
            let startTime = 0; // audioContext time when started
            let pausePosition = 0; // playback position in seconds when paused

            // --- Player State ---
            let playlist = [];
            let currentTrackIndex = 0;
            let isPlaying = false;
            let isShuffle = false;
            let repeatMode = 0; // 0 = none, 1 = repeat all, 2 = repeat one
            let shuffledIndices = [];
            let currentShuffleIndex = 0;

            // --- Canvas animation state ---
            let isInteractingWithCanvas = false;
            let progress = 0;
            let phaseShift = 0;
            const waveFrequency = 0.399;
            let targetAmplitude = 4;
            let currentAmplitude = 4;
            const style = getComputedStyle(document.documentElement);
            const activeTrackHeight = parseFloat(style.getPropertyValue('--active-track-height')) || 2;
            const inactiveTrackHeight = parseFloat(style.getPropertyValue('--inactive-track-height')) || 4;
            const thumbWidth = parseFloat(style.getPropertyValue('--thumb-width')) || 5;
            const thumbHeight = parseFloat(style.getPropertyValue('--thumb-height')) || 15;
            const activeTrackColor = style.getPropertyValue('--accent-color') || '#89b4fa';
            const inactiveTrackColor = 'rgba(255, 255, 255, 0.18)';
            const thumbColor = style.getPropertyValue('--primary-text') || '#e0e0e0';

            // Control requestAnimationFrame loop
            let animationStarted = false;

            // --- Utilities ---
            function initAudioContext() {
                if (!audioContext) {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                }
            }

            function formatTime(seconds) {
                if (isNaN(seconds) || seconds < 0) return '0:00';
                const minutes = Math.floor(seconds / 60);
                const secs = Math.floor(seconds % 60);
                return `${minutes}:${secs < 10 ? '0' : ''}${secs}`;
            }

            // Ensure canvas is sized correctly and scaled once
            function resizeCanvas() {
                const dpr = window.devicePixelRatio || 1;
                const rect = canvas.getBoundingClientRect();
                canvas.width = Math.round(rect.width * dpr);
                canvas.height = Math.round(rect.height * dpr);
                // reset transform and scale correctly (avoid accumulating scales)
                ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
            }

            // Start single animation loop
            function startAnimationLoop() {
                if (animationStarted) return;
                animationStarted = true;
                const loop = () => {
                    updateAndDraw();
                    requestAnimationFrame(loop);
                };
                requestAnimationFrame(loop);
            }

            // --- Scrolling text (marquee) ---
            function checkTextOverflow(element, container) {
                element.classList.remove('scrolling');
                element.style.removeProperty('--scroll-amount');

                // small timeout to ensure layout is stable
                setTimeout(() => {
                    const isOverflowing = element.scrollWidth > container.clientWidth + 2; // tolerance
                    if (isOverflowing) {
                        element.classList.add('scrolling');
                        const scrollAmount = container.clientWidth - element.scrollWidth;
                        element.style.setProperty('--scroll-amount', `${scrollAmount}px`);
                    }
                }, 50);
            }

            // --- File handling & metadata ---
            fileInput.addEventListener('change', (e) => {
                initAudioContext();
                const newFiles = Array.from(e.target.files || []);
                if (newFiles.length === 0) return;

                const wasEmpty = playlist.length === 0;
                playlist = playlist.concat(newFiles);

                if (isShuffle) {
                    generateShuffledPlaylist();
                }

                if (wasEmpty) {
                    currentTrackIndex = 0;
                    loadTrack(currentTrackIndex, false);
                }
            });

            function loadTrack(index, autoplay = false) {
                // stop any currently playing source
                stopSource();
                const file = playlist[index];
                if (!file) return;

                // set blurred background placeholder while decoding
                const playerUI = document.querySelector('.music-player');
                playerUI.style.setProperty('--background-image', 'url("https://via.placeholder.com/380")');

                // decode audio
                const reader = new FileReader();
                reader.onload = (ev) => {
                    initAudioContext();
                    audioContext.decodeAudioData(ev.target.result).then((buffer) => {
                        audioBuffer = buffer;
                        pausePosition = 0;
                        progress = 0;
                        totalTimeEl.textContent = formatTime(buffer.duration);
                        currentTimeEl.textContent = '0:00';
                        if (autoplay) playTrack();
                    }).catch((err) => console.error('Error decoding audio data:', err));
                };
                reader.readAsArrayBuffer(file);

                // read tags for artwork, title, artist
                window.jsmediatags.read(file, {
                    onSuccess: function(tag) {
                        const tags = tag.tags || {};
                        title.textContent = tags.title || file.name.replace(/\.[^/.]+$/, "");
                        artist.textContent = tags.artist || "Unknown Artist";

                        checkTextOverflow(title, titleContainer);
                        checkTextOverflow(artist, artistContainer);

                        if (tags.picture) {
                            const { data, format } = tags.picture;
                            let base64String = "";
                            for (let i = 0; i < data.length; i++) {
                                base64String += String.fromCharCode(data[i]);
                            }
                            const imageUri = `data:${format};base64,${window.btoa(base64String)}`;
                            artwork.src = imageUri;
                            playerUI.style.setProperty('--background-image', `url(${imageUri})`);
                        } else {
                            artwork.src = "https://via.placeholder.com/80";
                        }
                    },
                    onError: function(error) {
                        // fallback to file name
                        title.textContent = file.name.replace(/\.[^/.]+$/, "");
                        artist.textContent = "Unknown Artist";
                        artwork.src = "https://via.placeholder.com/80";
                        checkTextOverflow(title, titleContainer);
                        checkTextOverflow(artist, artistContainer);
                    }
                });
            }

            // --- Playback control helpers ---
            function createSourceNode(playbackRate = 1) {
                if (!audioContext || !audioBuffer) return null;
                const src = audioContext.createBufferSource();
                src.buffer = audioBuffer;
                src.playbackRate.value = playbackRate;
                src.connect(audioContext.destination);
                src.onended = onSourceEnded;
                return src;
            }

            function playTrack() {
                if (!audioBuffer) return;
                initAudioContext();

                // if already playing, do nothing
                if (isPlaying && sourceNode) return;

                // create and start a new source from pausePosition
                const rate = parseFloat(speedSlider.value);
                sourceNode = createSourceNode(rate);
                if (!sourceNode) return;

                // record start time and start playback from pausePosition
                startTime = audioContext.currentTime;
                try {
                    sourceNode.start(0, pausePosition);
                } catch (e) {
                    // some browsers may throw if start offset is near end — clamp it
                    const safeOffset = Math.max(0, Math.min(pausePosition, audioBuffer.duration - 0.001));
                    sourceNode.start(0, safeOffset);
                    startTime = audioContext.currentTime - (pausePosition - safeOffset) / (rate || 1);
                }

                isPlaying = true;
                playPauseBtn.innerHTML = pauseIconSVG;

                // ensure animation loop is running
                startAnimationLoop();
            }

            function pauseTrack() {
                if (!audioContext) return;
                if (sourceNode) {
                    // compute the accurate position considering playbackRate
                    const rate = sourceNode.playbackRate ? sourceNode.playbackRate.value : 1;
                    const elapsed = audioContext.currentTime - startTime;
                    pausePosition = pausePosition + elapsed * rate;

                    // stop and clean
                    sourceNode.onended = null;
                    try { sourceNode.stop(); } catch (e) { /* ignore */ }
                    sourceNode.disconnect && sourceNode.disconnect();
                    sourceNode = null;
                }
                isPlaying = false;
                playPauseBtn.innerHTML = playIconSVG;
            }

            function stopSource() {
                if (sourceNode) {
                    try { sourceNode.stop(); } catch (e) { /* ignore */ }
                    sourceNode.onended = null;
                    sourceNode.disconnect && sourceNode.disconnect();
                    sourceNode = null;
                }
                isPlaying = false;
                playPauseBtn.innerHTML = playIconSVG;
            }

            function onSourceEnded(ev) {
                // only trigger if ended naturally (not via stop)
                // reset pausePosition to 0 for next play
                pausePosition = 0;
                progress = 0;
                currentTimeEl.textContent = formatTime(0);

                if (repeatMode === 2) {
                    // repeat-one: same track again
                    playTrack();
                    return;
                }

                if (isShuffle) {
                    nextTrack(true);
                    return;
                }

                if (currentTrackIndex < playlist.length - 1) {
                    // move to next track
                    nextTrack(true);
                    return;
                }

                if (repeatMode === 1 && playlist.length > 0) {
                    // repeat-all
                    currentTrackIndex = (currentTrackIndex + 1) % playlist.length;
                    loadTrack(currentTrackIndex, true);
                    return;
                }

                // otherwise stop and show play icon
                isPlaying = false;
                playPauseBtn.innerHTML = playIconSVG;
            }

            function playPauseToggle() {
                if (isPlaying) pauseTrack(); else playTrack();
            }

            // --- Shuffle / Next / Prev logic ---
            function generateShuffledPlaylist() {
                shuffledIndices = Array.from({ length: playlist.length }, (_, i) => i);
                for (let i = shuffledIndices.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [shuffledIndices[i], shuffledIndices[j]] = [shuffledIndices[j], shuffledIndices[i]];
                }
                // try to keep current track at the start
                const pos = shuffledIndices.indexOf(currentTrackIndex);
                if (pos > 0) {
                    [shuffledIndices[0], shuffledIndices[pos]] = [shuffledIndices[pos], shuffledIndices[0]];
                }
                currentShuffleIndex = 0;
            }

            function nextTrack(autoplay = false) {
                stopSource();
                pausePosition = 0;

                if (isShuffle && playlist.length > 1) {
                    // advance shuffle index but ensure next index isn't the same as current
                    currentShuffleIndex = (currentShuffleIndex + 1) % shuffledIndices.length;
                    // if it points to current, move again (only possible if length>1)
                    if (shuffledIndices[currentShuffleIndex] === currentTrackIndex) {
                        currentShuffleIndex = (currentShuffleIndex + 1) % shuffledIndices.length;
                    }
                    currentTrackIndex = shuffledIndices[currentShuffleIndex];
                } else if (!isShuffle) {
                    currentTrackIndex = (currentTrackIndex + 1) % playlist.length;
                }

                loadTrack(currentTrackIndex, autoplay);
            }

            function prevTrack() {
                const wasPlaying = isPlaying;
                stopSource();
                pausePosition = 0;

                if (isShuffle && playlist.length > 1) {
                    currentShuffleIndex = (currentShuffleIndex - 1 + shuffledIndices.length) % shuffledIndices.length;
                    if (shuffledIndices[currentShuffleIndex] === currentTrackIndex) {
                        currentShuffleIndex = (currentShuffleIndex - 1 + shuffledIndices.length) % shuffledIndices.length;
                    }
                    currentTrackIndex = shuffledIndices[currentShuffleIndex];
                } else {
                    currentTrackIndex = (currentTrackIndex - 1 + playlist.length) % playlist.length;
                }

                loadTrack(currentTrackIndex, wasPlaying);
            }

            // --- UI Event listeners ---
            playPauseBtn.addEventListener('click', playPauseToggle);
            nextBtn.addEventListener('click', () => nextTrack(isPlaying));
            prevBtn.addEventListener('click', prevTrack);

            shuffleBtn.addEventListener('click', () => {
                isShuffle = !isShuffle;
                shuffleBtn.classList.toggle('active', isShuffle);
                if (isShuffle && playlist.length > 0) generateShuffledPlaylist();
            });

            repeatAllBtn.addEventListener('click', () => {
                // toggle between none and repeat-all
                repeatMode = (repeatMode === 1) ? 0 : 1;
                updateRepeatButtons();
            });

            repeatOneBtn.addEventListener('click', () => {
                repeatMode = (repeatMode === 2) ? 0 : 2;
                updateRepeatButtons();
            });

            function updateRepeatButtons() {
                repeatAllBtn.classList.remove('active');
                repeatOneBtn.classList.remove('active');
                if (repeatMode === 1) repeatAllBtn.classList.add('active');
                else if (repeatMode === 2) repeatOneBtn.classList.add('active');
            }

            // --- Canvas seeking interaction ---
            let isDraggingProgressBar = false;

            function computePlaybackPositionFromCanvasEvent(e) {
                if (!audioBuffer) return 0;
                const rect = canvas.getBoundingClientRect();
                const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                const offsetX = clientX - rect.left;
                const newProgress = Math.max(0, Math.min(1, offsetX / rect.width));
                return newProgress * audioBuffer.duration;
            }

            function handleSeek(e) {
                if (!audioBuffer) return;
                const newPos = computePlaybackPositionFromCanvasEvent(e);
                // set pausePosition; if playing, recreate source from new position
                pausePosition = newPos;
                progress = audioBuffer.duration ? (pausePosition / audioBuffer.duration) : 0;
                currentTimeEl.textContent = formatTime(pausePosition);

                if (isPlaying) {
                    // restart playback from new position
                    if (sourceNode) {
                        try { sourceNode.stop(); } catch (err) { /* ignore */ }
                        sourceNode.onended = null;
                        sourceNode.disconnect && sourceNode.disconnect();
                        sourceNode = null;
                    }
                    playTrack();
                }
            }

            progressContainer.addEventListener('mousedown', (e) => {
                isDraggingProgressBar = true;
                isInteractingWithCanvas = true;
                handleSeek(e);
            });

            document.addEventListener('mousemove', (e) => {
                if (isDraggingProgressBar) handleSeek(e);
            });

            document.addEventListener('mouseup', () => {
                isDraggingProgressBar = false;
                isInteractingWithCanvas = false;
            });

            progressContainer.addEventListener('touchstart', (e) => {
                isDraggingProgressBar = true;
                isInteractingWithCanvas = true;
                handleSeek(e);
            }, { passive: true });

            document.addEventListener('touchmove', (e) => { if (isDraggingProgressBar) handleSeek(e); }, { passive: true });
            document.addEventListener('touchend', () => { isDraggingProgressBar = false; isInteractingWithCanvas = false; });

            // --- Speed controls ---
            function setPlaybackSpeed(speed) {
                const minSpeed = parseFloat(speedSlider.min);
                const maxSpeed = parseFloat(speedSlider.max);
                speed = Math.max(minSpeed, Math.min(maxSpeed, speed));

                speedSlider.value = speed;
                speedValue.textContent = `${parseFloat(speed).toFixed(2)}x`;

                if (sourceNode) {
                    // To change playback rate during playback we adjust the existing node if possible,
                    // otherwise restart from current logical position
                    try {
                        sourceNode.playbackRate.value = speed;
                    } catch (e) {
                        // recreate source to apply rate change (preserve position)
                        const wasPlaying = isPlaying;
                        if (wasPlaying) {
                            if (sourceNode) { try { sourceNode.stop(); } catch (e) {} }
                            playTrack();
                        }
                    }
                }
            }

            toggleSpeedBtn.addEventListener('click', () => {
                speedControls.classList.toggle('expanded');
                toggleSpeedBtn.classList.toggle('active');
            });

            speedSlider.addEventListener('input', (e) => { setPlaybackSpeed(parseFloat(e.target.value)); });
            speedDecreaseBtn.addEventListener('click', () => { setPlaybackSpeed(parseFloat(speedSlider.value) - 0.05); });
            speedIncreaseBtn.addEventListener('click', () => { setPlaybackSpeed(parseFloat(speedSlider.value) + 0.05); });

            // --- Drawing / animation update ---
            function updateAndDraw() {
                // update playback position
                if (isPlaying && audioBuffer && audioContext && sourceNode) {
                    const rate = sourceNode.playbackRate ? sourceNode.playbackRate.value : 1;
                    const elapsed = audioContext.currentTime - startTime; // realtime
                    const logicalPosition = pausePosition + elapsed * rate;
                    // clamp
                    const clamped = Math.max(0, Math.min(audioBuffer.duration, logicalPosition));
                    progress = audioBuffer.duration ? (clamped / audioBuffer.duration) : 0;
                    currentTimeEl.textContent = formatTime(clamped);
                }

                // draw canvas
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                const width = canvas.clientWidth;
                const height = canvas.clientHeight;
                const centerY = height / 2;

                // amplitude behaviour
                targetAmplitude = (isInteractingWithCanvas || !isPlaying) ? 0 : 2;
                currentAmplitude += (targetAmplitude - currentAmplitude) * 0.08;

                const activeTrackEnd = width * progress;

                // inactive track
                ctx.beginPath();
                ctx.moveTo(activeTrackEnd, centerY);
                ctx.lineTo(width, centerY);
                ctx.lineWidth = inactiveTrackHeight;
                ctx.strokeStyle = inactiveTrackColor;
                ctx.lineCap = 'round';
                ctx.stroke();

                // active track (wave)
                ctx.beginPath();
                ctx.lineWidth = activeTrackHeight;
                ctx.strokeStyle = activeTrackColor;
                ctx.lineCap = 'round';

                if (currentAmplitude > 0.12 && activeTrackEnd > 0) {
                    for (let x = 0; x <= activeTrackEnd; x += 2) {
                        const waveY = centerY + currentAmplitude * Math.sin(x * waveFrequency - phaseShift);
                        if (x === 0) ctx.moveTo(x, waveY);
                        else ctx.lineTo(x, waveY);
                    }
                } else if (activeTrackEnd > 0) {
                    ctx.moveTo(0, centerY);
                    ctx.lineTo(activeTrackEnd, centerY);
                }
                ctx.stroke();

                // thumb
                const thumbX = activeTrackEnd;
                ctx.beginPath();
                ctx.strokeStyle = thumbColor;
                ctx.lineWidth = thumbWidth;
                ctx.lineCap = 'round';
                ctx.moveTo(thumbX, centerY - thumbHeight / 2);
                ctx.lineTo(thumbX, centerY + thumbHeight / 2);
                ctx.stroke();

                // phase movement
                if (isPlaying) phaseShift -= 0.04;
            }

            // --- Canvas resize handling ---
            window.addEventListener('resize', () => { resizeCanvas(); });
            resizeCanvas();
            startAnimationLoop();

            // --- Initial UI state ---
            updateRepeatButtons();

            // expose a small API for testing/debugging (optional)
            window.__PLAYER = {
                play: playTrack,
                pause: pauseTrack,
                load: loadTrack,
                next: nextTrack,
                prev: prevTrack,
                getState: () => ({ isPlaying, currentTrackIndex, playlistLength: playlist.length })
            };
        });
    </script>
</body>

</html>
